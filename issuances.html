<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K4BTZM0NNK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-K4BTZM0NNK');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lockrion â€” Issuances</title>

  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <link rel="manifest" href="/icons/site.webmanifest">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="bg"></div>

  <div class="wrap">
    <header>
      <iframe class="logo-mini" src="lockrion-logo.html" scrolling="no"></iframe>
      <nav>
        <a href="index.html">Home</a>
        <a href="how.html">How it works</a>
      </nav>
    </header>

    <div class="hero">
      <h1>Issuances Portal</h1>

      <div class="desc">
        <p>
          An <b>issuance</b> is a single on-chain contract instance with a fixed reward reserve and a time-locked deposit window.
          You choose an issuance, deposit the specified token (<b>LOCK_MINT</b>) during the active period, and later claim rewards.
        </p>
        <p>
          Each issuance has its own parameters: <b>start time</b>, <b>maturity time</b>, <b>reward reserve size</b>, and the deposit mint.
          The reserve is funded by the issuer; settlement is deterministic on Solana.
        </p>
      </div>
    </div>

    <div class="launch-notice">
      ðŸš€ The Lockrion Issuances Portal is launching soon.
      Smart-contract deployments are in final preparation.
      Public issuances will become available shortly.
    </div>

    <!-- ONE window, inside it: issuances-list.html -->
    <div class="panel" aria-label="Issuances list window">
      <div class="panel-top">
        <div class="panel-title panel-title-split">
          <span class="chip"><i></i> Issuances list</span>
          <button class="btn btn-outline" id="claimBtn">Claim FSM</button>
        </div>
      </div>

      <div class="panel-body">
        <iframe class="embed" src="./issuances-list.html" scrolling="no"></iframe>
      </div> 

    </div>
    <footer>
      Â© Lockrion. Deterministic issuance contracts on Solana.
    </footer>
  </div>

  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

<script>
  const BACKEND = "https://fsm-claim-backend.onrender.com";

  async function connectWallet() {
    if (!window.solana || !window.solana.isPhantom) {
      alert("Install Phantom wallet");
      return null;
    }
    const resp = await window.solana.connect();
    return resp.publicKey.toString();
  }

  async function postJson(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {}),
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  }

  document.getElementById("claimBtn").onclick = async () => {
    const btn = document.getElementById("claimBtn");
    btn.disabled = true;
    btn.textContent = "Claiming...";

    try {
      const wallet = await connectWallet();
      if (!wallet) return;

      // 0) get server challenge
      const ch = await postJson(BACKEND + "/challenge", { wallet });
      if (ch.alreadyClaimed) {
        alert("Already claimed this week.");
        return;
      }

      const message = ch.message;
      if (!message) throw new Error("No challenge message returned");

      // 1) sign server message (BASE64 signature)
      const encoded = new TextEncoder().encode(message);
      const signed = await window.solana.signMessage(encoded, "utf8");
      const signature = btoa(String.fromCharCode(...signed.signature));

      // 2) request fully-signed tx from backend
      const claim = await postJson(BACKEND + "/claim", { wallet, signature });
      if (claim.alreadyClaimed) {
        alert("Already claimed this week.");
        return;
      }
      if (!claim.txBase64) throw new Error("No transaction returned");

      // 3) submit tx via backend (backend uses Helius RPC)
      const sub = await postJson(BACKEND + "/submit", { wallet, txBase64: claim.txBase64 });
      const txSig = sub.txSig;
      if (!txSig) throw new Error("No txSig returned from /submit");

      // 4) backend confirmation + verification
      await postJson(BACKEND + "/confirm", { wallet, txSig });

      alert("FSM claimed successfully!");
    } catch (e) {
      console.error(e);
      alert(e?.message || "Claim failed");
    } finally {
      btn.disabled = false;
      btn.textContent = "Claim FSM";
    }
  };
</script>

</body>
</html>